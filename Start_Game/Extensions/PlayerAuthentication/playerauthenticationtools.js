var gdjs;(function(u){const a=new u.Logger("Player Authentication"),g=u.playerAuthenticationComponents;let X;(function(s){let b=null,T=null,v=null,S=!1,C=!1,W=null,y=null,k=null,D=null,h=null,c=null,P=null,x=null,R=null,f=null,m=null;const Y=e=>{N(e)==="games-platform"&&(a.info("Notifying parent window that player authentication is ready."),window.parent.postMessage({id:"playerAuthReady"},"*"),P=setTimeout(()=>{a.info("Removing automatic games platform authentication listener."),O()},3e3))},Z=e=>{N(e)==="games-platform"&&(O(),R=t=>{L({runtimeScene:e,event:t,checkOrigin:!0})},window.addEventListener("message",R,!0))},ee=e=>{const t=e.getGame().getAdditionalOptions();if(t&&t.isPreview){const n=t.playerId,i=t.playerToken,o=t.playerUsername;n&&i&&(a.info(`Automatically logging in the player with ID ${n} as it's a preview.`),F({userId:n,username:o||null,userToken:i}),q(e))}};u.registerRuntimeScenePostEventsCallback(()=>{S=!1}),u.registerFirstRuntimeSceneLoadedCallback(e=>{ee(e),Z(e),Y(e)});const _=e=>`${e}_authenticatedUser`,j=({runtimeGame:e,gameId:t,connectionId:n,authWindowOptions:i})=>{const o="https://gd.games",r=new URLSearchParams;if(r.set("gameId",t),n&&r.set("connectionId",n),e.isUsingGDevelopDevelopmentEnvironment()&&r.set("dev","true"),r.set("allowLoginProviders","true"),i)for(const[d,l]of Object.entries(i))r.set(d,l.toString());return`${o}/auth?${r.toString()}`},N=e=>e.getGame().getRenderer().getElectron()?"electron":te(e)?"web-iframe":typeof cordova!="undefined"?"cordova-websocket":window.parent!==window&&(document.referrer.indexOf("https://gd.games")===0||document.referrer.indexOf("http://localhost:4000")===0)?"games-platform":"web",te=e=>{const t=e.getGame().getAdditionalOptions();return t&&t.isPreview&&t.allowAuthenticationUsingIframeForPreview};s.isAuthenticated=()=>(C||I(),v!==null),s.hasLoggedIn=()=>S,s.getUsername=()=>(C||I(),b||""),s.getUserToken=()=>(C||I(),v||null),s.getUserId=()=>(C||I(),T||"");const V=(e,t,n=0)=>{const o=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(o,{method:"HEAD"}).then(r=>r.status!==200?(a.warn(`Error while fetching the game: ${r.status} ${r.statusText}`),r.status===404||n>2?!1:V(e,t,n+1)):!0,r=>(a.error("Error while fetching game:",r),!1))};s.logout=e=>{b=null,v=null,T=null;const t=u.projectData.properties.projectUuid;if(!t){a.error("Missing game id in project properties.");return}window.localStorage.removeItem(_(t)),G(e),s.removeAuthenticationBanner(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayLoggedOutNotification(n)};const I=()=>{const e=u.projectData.properties.projectUuid;if(!e){a.error("Missing game id in project properties.");return}try{const t=window.localStorage.getItem(_(e));if(!t){C=!0;return}const n=JSON.parse(t);b=n.username,T=n.userId,v=n.userToken,C=!0}catch(t){a.warn("Unable to read authentication details from localStorage. Player authentication will not be available.",t)}},G=e=>{if(s.removeAuthenticationContainer(e),J(),m&&(a.info("Closing authentication websocket connection."),m.close(),m=null),W&&(W.close(),W=null),typeof SafariViewController!="undefined")try{SafariViewController.hide()}catch{a.info("Could not hide login window. Waiting for user to do it.")}},F=({username:e,userId:t,userToken:n})=>{e||a.warn("The authenticated player does not have a username"),b=e,T=t,v=n,S=!0;const i=u.projectData.properties.projectUuid;if(!i){a.error("Missing game id in project properties.");return}try{window.localStorage.setItem(_(i),JSON.stringify({username:b,userId:T,userToken:v}))}catch(o){a.warn("Unable to save the authentication details to localStorage. Player authentication will not be available.",o)}};s.login=({runtimeScene:e,userId:t,username:n,userToken:i})=>{F({userId:t,username:n,userToken:i}),G(e),s.removeAuthenticationBanner(e);const o=e.getGame().getRenderer().getDomElementContainer();if(!o){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayLoggedInNotification(o,b||"Anonymous")};const L=function({runtimeScene:e,event:t,checkOrigin:n,onDone:i}){const o=l=>{s.login({runtimeScene:e,userId:l.data.body.userId,username:l.data.body.username,userToken:l.data.body.token}),U(e),i&&i("logged")},r=l=>{F({userId:l.data.body.userId,username:l.data.body.username,userToken:l.data.body.token}),O(),q(e),i&&i("logged")};if(!(n&&!["https://gd.games","http://localhost:4000"].includes(t.origin))){if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");a.info("Received authentication result, logging in player."),o(t);break}case"alreadyAuthenticated":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");if(a.info("Player is already authenticated, logging in player."),y){o(t);break}r(t);break}}}},w=function(e,t){a.error(t),G(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayErrorNotification(n),U(e)},ne=e=>{J();const t=15*60*1e3;x=setTimeout(()=>{a.info("Authentication window did not send message in time. Closing it."),G(e),U(e)},t)},J=()=>{x&&clearTimeout(x)},K=function(e){const t=()=>{s.removeAuthenticationBanner(e)},n=()=>{s.openAuthenticationWindow(e)};return v?g.computeAuthenticatedBanner(n,t,b):g.computeNotAuthenticatedBanner(n,t)};s.displayAuthenticationBanner=function(e){if(e.getGame().isInGameEdition())return;if(c){c.style.opacity="1";return}C||I();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}c=K(e),t.appendChild(c)};const q=function(e){if(!c)return;const t=e.getGame().getRenderer().getDomElementContainer();if(!t){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=c;c=K(e),t.replaceChild(c,n)},z=(e,t,n)=>new Promise(i=>{let o=!1;const r=e.getGame().isUsingGDevelopDevelopmentEnvironment()?`wss://api-ws-dev.gdevelop.io/play?gameId=${t}&connectionType=login`:`wss://api-ws.gdevelop.io/play?gameId=${t}&connectionType=login`;m=new WebSocket(r),m.onopen=()=>{a.info("Opened authentication websocket connection."),m&&m.send(JSON.stringify({action:"getConnectionId"}))},m.onerror=()=>{a.info("Error in authentication websocket connection."),o||(o=!0,i("errored")),w(e,"Error while connecting to the authentication server.")},m.onclose=()=>{a.info("Closing authentication websocket connection."),o||(o=!0,i("dismissed"))},m.onmessage=d=>{if(d.data){const l=JSON.parse(d.data);switch(l.type){case"authenticationResult":{const p=l.data;s.login({runtimeScene:e,userId:p.userId,username:p.username,userToken:p.token}),U(e),o=!0,i("logged");break}case"connectionId":{const A=l.data.connectionId;if(!A){a.error("No WebSocket connectionId received"),o=!0,i("errored");return}a.info("WebSocket connectionId received."),n({connectionId:A,resolve:i});break}}}}}),ie=(e,t,n)=>z(e,t,({connectionId:i})=>{const o=j({runtimeGame:e.getGame(),gameId:t,connectionId:i,authWindowOptions:n}),r=e.getGame().getRenderer().getElectron(),d=()=>r.shell.openExternal(o);d(),h&&g.addAuthenticationUrlToTextsContainer(d,h)}),ae=(e,t,n)=>z(e,t,({connectionId:i,resolve:o})=>{const r=j({runtimeGame:e.getGame(),gameId:t,connectionId:i,authWindowOptions:n});if(typeof SafariViewController=="undefined"){a.error("Cordova plugin SafariViewController is not installed."),o("errored");return}SafariViewController.isAvailable(function(d){if(!d){a.error("Cordova plugin SafariViewController is installed but not available"),o("errored");return}a.info("Opening authentication window for Cordova with SafariViewController."),SafariViewController.show({url:r,hidden:!1,animated:!0,transition:"slide",enterReaderModeIfAvailable:!1,barColor:"#000000",tintColor:"#ffffff",controlTintColor:"#ffffff"},function(l){l.event==="closed"&&o("dismissed")},function(l){a.log("Error opening authentication window: "+JSON.stringify(l)),o("errored")})})}),re=(e,t,n)=>new Promise(i=>{const o=j({runtimeGame:e.getGame(),gameId:t,authWindowOptions:n});let r=!1;f=B=>{L({runtimeScene:e,event:B,checkOrigin:!0,onDone:M=>{r||(r=!0,i(M))}})},window.addEventListener("message",f,!0);const d=screen.width/2-500/2,l=screen.height/2-600/2,p=`left=${d},top=${l},width=500,height=600`,A=()=>{W=window.open(o,"authentication",p)};A(),h&&g.addAuthenticationUrlToTextsContainer(A,h)}),se=(e,t,n)=>new Promise(i=>{if(!D||!k||!h){a.error("Can't open an authentication iframe - no iframe container, loader container or text container was opened for it.");return}const o=j({runtimeGame:e.getGame(),gameId:t,authWindowOptions:n});f=r=>{L({runtimeScene:e,event:r,checkOrigin:!0,onDone:i})},window.addEventListener("message",f,!0),g.displayIframeInsideAuthenticationContainer(D,k,h,o)});s.openAuthenticationWindowForGamesPlatform=(e,t,n)=>new Promise(i=>{O(),f=o=>{L({runtimeScene:e,event:o,checkOrigin:!0,onDone:i})},window.addEventListener("message",f,!0),window.parent.postMessage({id:"openGameAuthenticationDialog",gameId:t,disableGuestLogin:n.disableGuestLogin},"*")}),s.openAuthenticationWindow=(e,t={disableGuestLogin:!1})=>new u.PromiseTask(new Promise(n=>{e.getGame().isInGameEdition()&&n({status:"dismissed"});const i=e.getGame().getRenderer().getDomElementContainer();if(!i){w(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed."),n({status:"errored"});return}const o=u.projectData.properties.projectUuid;if(!o){w(e,"The game ID is missing, the authentication window cannot be opened."),n({status:"errored"});return}let r=!1;const d=()=>{G(e),s.displayAuthenticationBanner(e),r=!0,n({status:"dismissed"})};c&&(c.style.opacity="0");const l=N(e),{rootContainer:p,loaderContainer:A,iframeContainer:B}=g.computeAuthenticationContainer(d);y=p,k=A,D=B,i.appendChild(y),(async()=>{const M=await V(e.getGame(),o);if(k){const Q=e.getGame().getRenderer().getElectron(),ge=Q?()=>Q.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):null;h=g.addAuthenticationTextsToLoadingContainer(k,l,M,ge)}if(!M)return;ne(e);let E;switch(l){case"electron":E=await ie(e,o,t);break;case"cordova-websocket":E=await ae(e,o,t);break;case"web-iframe":E=await se(e,o,t);break;case"games-platform":E=await s.openAuthenticationWindowForGamesPlatform(e,o,t);break;case"web":default:E=await re(e,o,t);break}r||(E==="dismissed"&&d(),n({status:E}))})()})),s.isAuthenticationWindowOpen=function(){return!!y},s.removeAuthenticationContainer=function(e){ue();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}y&&t.removeChild(y),y=null,k=null,D=null,h=null};const ue=function(){f&&(window.removeEventListener("message",f,!0),f=null)},O=function(){R&&(window.removeEventListener("message",R,!0),R=null),P&&(clearTimeout(P),P=null)};s.removeAuthenticationBanner=function(e){if(!c){a.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(c),c=null};const U=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(X=u.playerAuthentication||(u.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
